FUNCTION /SKN/F_SW_10_03_PR_PO_VAL_CHK .
*"----------------------------------------------------------------------
*"*"Local Interface:
*"  EXPORTING
*"     VALUE(IS_ALERT) TYPE  CHAR1
*"  TABLES
*"      T_SELECT STRUCTURE  RSSELECT OPTIONAL
*"      T_DATA STRUCTURE  /SKN/S_SW_10_03_PR_PO_VAL_CHK OPTIONAL
*"----------------------------------------------------------------------
DATA_SINGLE: LANGU  LANGU,
             BACKDAYS INT4,
             DATE_REF_FLD NAME_FELD,
             DURATION_UNIT  /SKN/E_SW_DURATION_UNIT.
 LV_BACKDAYS = 10.
 LV_DURATION_UNIT = 'D'.
 LV_LANGU = SY-LANGU.
 LV_DATE_REF_FLD = 'BADAT'. "PO date
 SELECT_SINGLE: LANGU,
                BACKDAYS,
                DATE_REF_FLD,
                DURATION_UNIT.
DATA_MULTY: BANFN        BANFN,
            BNFPO        BNFPO,
            BSART        BBSRT,
            BSTYP        BSTYP,
            BSAKZ        BSAKZ,
            STATU        BANST,
            ESTKZ        ESTKZ,
            FRGKZ        FRGKZ,
            EKGRP        EKGRP,
            ERNAM        ERNAM,
            FRGRL        FRGRL,
            EBELN        BSTNR,
            EKORG        EKORG,
            FRGGR        FRGGR,
            FRGST        FRGST,
            RESWK        RESWK,
            WERKS	       EWERK,
            LIFNR        ELIFN,
            ERDAT        AEDAT,
            BEDAT        BEDAT,
            BADAT        BADAT,
            WAERS        WAERS,
            DATUM        SY-DATUM,
            DURATION    /SKN/E_SW_DURATION,
            LOEKZ       ELOEK,
            FRGC        FRGCO,
            PO_PREQ_DIFF BWERT.
SELECT_MULTY:
            BANFN,
            BNFPO,
            BSART,
            BSTYP,
            BSAKZ,
            STATU,
            ESTKZ,
            FRGKZ,
            EKGRP,
            ERNAM,
            ERDAT,"Changed on
            FRGRL,
            EBELN,
            EKORG,
            FRGGR,
            FRGST,
            RESWK,
            WERKS,
            LIFNR,
            BEDAT,
            BADAT,
            WAERS,
            DATUM,
            DURATION,
            LOEKZ,
            FRGC,
            PO_PREQ_DIFF.
CONVERT_MULTY: EBELN ALPHA,
               LIFNR ALPHA.
 "--- Set default for LOEKZ (not deleted only)
 READ TABLE R_LOEKZ INTO RS_LOEKZ INDEX 1.
 IF SY-TFILL = 0.
   RS_LOEKZ-SIGN = 'I'.
   RS_LOEKZ-OPTION = 'EQ'.
   RS_LOEKZ-LOW = ' '.
   APPEND RS_LOEKZ TO R_LOEKZ.
 ENDIF.
RANGES : R_FLD_NAME FOR DD03P-FIELDNAME,
         R_FLD_VAL FOR DD03P-FIELDNAME .
DATA :   FLD_NAME TYPE FIELDNAME.
DATA : I TYPE I,
       CI(1) TYPE C,
       NFIELDS TYPE I VALUE 3.   "
DATA : BACKDAYS  TYPE I ,
       DATE_FROM LIKE SY-DATUM .
DATA : LANGU LIKE SY-LANGU .
DATA : IS_OUT(1) TYPE C.
DATA : TIME_DIFF TYPE  INT4 .
DATA: LV_DOMNAME LIKE  DD07V-DOMNAME,
      LV_DOMVALUE LIKE  DD07V-DOMVALUE_L,
      LV_DDTEXT LIKE  DD07V-DDTEXT.
DATA: LV_FRGCO  TYPE FRGCO.
DATA : SY_TABIX LIKE SY-TABIX .
DATA : FLD(60) TYPE C .
DATA : REF_DATE TYPE D.
*data: lra_range type range of DD03P-FIELDNAME.
FIELD-SYMBOLS:  TYPE ANY ,
               <FS_V> TYPE ANY .
DATA : BEGIN OF SW_STRUCTURE OCCURS 0.
  INCLUDE STRUCTURE /SKN/S_SW_S_FCAT .
DATA : END OF SW_STRUCTURE .
DATA : LS_VBPA TYPE VBPA,
       LT_VBPA LIKE TABLE OF LS_VBPA.
DATA : LV_DATA_POSNR TYPE POSNR.
**********
DATA: LV_FRGSX TYPE FRGSX.
DATA: LV_RESWK TYPE WERKS_D.
DATA: LV_WERKS TYPE WERKS_D.
DATA: LV_WLIEF TYPE LIFNR.
DATA: LV_BSART TYPE ESART.
DATA: LS_T161 TYPE T161,
      LT_T161 LIKE TABLE OF LS_T161.
DATA: LS_EBAN TYPE EBAN,
      LT_EBAN LIKE TABLE OF LS_EBAN.
DATA: BEGIN OF LS_PO,
       BANFN  TYPE BANFN,
       BNFPO TYPE BNFPO,
       EBELN TYPE EBELN,
       EBELP TYPE EBELP,
       LIFNR TYPE WLIEF,
       EKORG TYPE EKORG,
       NETWR TYPE BWERT,
       WKURS TYPE WKURS,
       PO_WAERS TYPE WAERS,
       BEDAT TYPE EBDAT,
       NETWR_LOCAL_CURR TYPE BWERT,
       PR_WAERS TYPE WAERS,
      END OF LS_PO.
DATA: LT_PO LIKE TABLE OF LS_PO.
DATA: BEGIN OF LS_PO_PR,
       BANFN  TYPE BANFN,
       BNFPO TYPE BNFPO,
       LIFNR TYPE WLIEF,
       EKORG TYPE EKORG,
       NETWR_LOCAL_CURR TYPE BWERT,
      END OF LS_PO_PR.
DATA: LT_PO_PR LIKE TABLE OF LS_PO_PR.
"--- Run Cloud Mode -----
  DATA_SINGLE: SW_DEST RFCDEST.             .
  SELECT_SINGLE: SW_DEST.
  IF LV_SW_DEST IS NOT INITIAL.
    CALL FUNCTION '/SKN/FC_SW_10_03_PR_PO_VAL_CHK'
      IMPORTING
        IS_ALERT       = IS_ALERT
      TABLES
        T_SELECT       = T_SELECT
        T_DATA         = T_DATA.
  ENDIF.
  CHECK LV_SW_DEST IS INITIAL.
"--- Run Cloud Mode -----
 "--- Prepare BSART
   SELECT *
     FROM T161
     INTO CORRESPONDING FIELDS OF TABLE LT_T161
     WHERE BSTYP = 'B'
       AND BSAKZ = ' '
       AND BSART IN R_BSART.
     REFRESH R_BSART.
     LOOP AT LT_T161 INTO LS_T161.
       RS_BSART-SIGN = 'I'.
       RS_BSART-OPTION = 'EQ'.
       RS_BSART-LOW = LS_T161-BSART.
       APPEND RS_BSART TO R_BSART.
     ENDLOOP.
   IF R_DATUM[] IS INITIAL .
     RS_DATUM-SIGN = 'I' .
      RS_DATUM-OPTION = 'GE' .
       DATE_FROM = SY-DATUM - LV_BACKDAYS .
       RS_DATUM-LOW = DATE_FROM .
        APPEND RS_DATUM TO R_DATUM.
   ENDIF.
 "--- Set Reference Date Field
   CASE LV_DATE_REF_FLD.
     WHEN 'BEDAT'.
       R_BEDAT[] = R_DATUM[]. "Purchase Order Date
     WHEN 'BADAT'.
       R_BADAT[] = R_DATUM[]. "Request Order Date
     WHEN 'ERDAT'.
       R_ERDAT[] = R_DATUM[]. "Changed On
     WHEN OTHERS.
       R_BADAT[] = R_DATUM[].
   ENDCASE.
*--- Retrieve data
  CLEAR IS_ALERT .
  REFRESH T_DATA.
  REFRESH LT_EBAN.
  SELECT *
    FROM EBAN
    INTO CORRESPONDING FIELDS OF TABLE LT_EBAN
    WHERE FRGRL IN R_FRGRL    "  EQ 'X'
      AND FRGGR IN R_FRGGR
      AND EBELN IN R_EBELN
***      and BSTYP = 'F'  " PO !!! Remove for Test
      AND EKORG IN R_EKORG
      AND LIFNR IN R_LIFNR
      AND RESWK IN R_RESWK
      AND BEDAT IN R_BEDAT
      AND BADAT IN R_BADAT
      AND ERDAT IN R_ERDAT
      AND BSART IN R_BSART
      AND EKGRP IN R_EKGRP
      AND ERNAM IN R_ERNAM
      AND WERKS	IN R_WERKS
      AND WAERS IN R_WAERS
      """and LOEKZ  in R_LOEKZ
      AND LOEKZ = ' '
      AND FRGKZ IN R_FRGKZ
      AND FRGST <>  ''
      AND STATU = 'B'
      AND ESTKZ IN ('D', 'F', 'R')
      AND KNTTP <> ' '
       .
   CHECK LT_EBAN[] IS NOT INITIAL.
   SORT LT_EBAN BY BANFN BNFPO.
   SELECT EKPO~EBELN EKPO~EBELP
          EKPO~NETWR EKKO~WAERS AS PO_WAERS
          EKKO~BEDAT EKKO~WKURS
          EKKO~LIFNR EKKO~EKORG
          EKET~BANFN EKET~BNFPO
     INTO CORRESPONDING FIELDS OF TABLE LT_PO
     FROM EKET
       INNER JOIN EKPO
         ON EKPO~EBELN = EKET~EBELN AND
            EKPO~EBELP = EKET~EBELP
       INNER JOIN EKKO
         ON EKKO~EBELN = EKET~EBELN
     FOR ALL ENTRIES IN LT_EBAN
     WHERE EKET~BANFN = LT_EBAN-BANFN
       AND EKET~BNFPO = LT_EBAN-BNFPO
     .
    SORT LT_PO BY BANFN BNFPO.
    LOOP AT LT_PO INTO LS_PO.
      SY_TABIX = SY-TABIX.
      LS_PO-NETWR_LOCAL_CURR = LS_PO-NETWR.
      READ TABLE LT_EBAN INTO LS_EBAN WITH KEY BANFN = LS_PO-BANFN
                                               BNFPO = LS_PO-BNFPO
                                      BINARY SEARCH.
      IF SY-SUBRC IS INITIAL.
        LS_PO-PR_WAERS = LS_EBAN-WAERS.
        IF LS_PO-PR_WAERS <> LS_PO-PO_WAERS.
          LS_PO-NETWR_LOCAL_CURR = LS_PO-NETWR * LS_PO-WKURS.
        ENDIF.
      ENDIF.
      MODIFY LT_PO FROM LS_PO INDEX SY_TABIX.
    ENDLOOP.
    "--- Aggregate LT_PC by BANFN
    REFRESH LT_PO_PR.
    LOOP AT LT_PO INTO LS_PO.
      MOVE-CORRESPONDING LS_PO TO LS_PO_PR.
      COLLECT LS_PO_PR INTO LT_PO_PR.
    ENDLOOP.
    REFRESH T_DATA.
    LOOP AT LT_PO_PR INTO LS_PO_PR.
      MOVE-CORRESPONDING LS_PO_PR TO T_DATA.
      T_DATA-TOT_PO_VAL = LS_PO_PR-NETWR_LOCAL_CURR.
      READ TABLE LT_EBAN INTO LS_EBAN WITH KEY BANFN = LS_PO_PR-BANFN
                                               BNFPO = LS_PO_PR-BNFPO
                                      BINARY SEARCH.
      IF SY-SUBRC IS INITIAL.
        MOVE-CORRESPONDING LS_EBAN TO T_DATA.
        MOVE-CORRESPONDING LS_PO_PR TO T_DATA.
        T_DATA-TOT_PREQ_VAL = ( LS_EBAN-MENGE * LS_EBAN-PREIS ) / LS_EBAN-PEINH.
        T_DATA-PO_PREQ_DIFF = T_DATA-TOT_PO_VAL - T_DATA-TOT_PREQ_VAL.
      ENDIF.
      IF T_DATA-PO_PREQ_DIFF IN R_PO_PREQ_DIFF.
        APPEND T_DATA.
      ENDIF.
    ENDLOOP.
*********************************************************************************
  "--- Get Release Code
  LOOP AT T_DATA .
    SY_TABIX = SY-TABIX .
    LV_FRGSX = T_DATA-FRGST.
    CALL FUNCTION '/SKN/F_SW_10_PO_GET_FRGC'
      EXPORTING
        FRGGR                   = T_DATA-FRGGR
        FRGSX                   = LV_FRGSX         """t_data-FRGST        "-frgsx
        FRGZU                   = T_DATA-FRGZU
      IMPORTING
        FRGC                    = T_DATA-FRGC
      EXCEPTIONS
        WRONG_COMBINATION       = 1
        OTHERS                  = 2.
    IF SY-SUBRC = 0.
      MODIFY T_DATA INDEX SY_TABIX.
    ENDIF.
  ENDLOOP.
DELETE T_DATA WHERE FRGC  NOT IN R_FRGC .
*-- Calculate Status Duration (associating to Reference Field (DATE_REF_FLD)
  LOOP AT T_DATA .
    SY_TABIX = SY-TABIX .
    CONCATENATE 'T_DATA-' LV_DATE_REF_FLD INTO FLD .
    ASSIGN (FLD) TO .
    REF_DATE =  .
    IF NOT REF_DATE IS INITIAL.
      T_DATA-DURATION_UNIT = LV_DURATION_UNIT.
      CALL FUNCTION '/SKN/F_SW_GET_TIME_DIFF'
        EXPORTING
          D_FROM            = REF_DATE
          T_FROM            = SY-UZEIT
          D_TO              = SY-DATUM
          T_TO              = SY-UZEIT
          TIME_UNIT         = LV_DURATION_UNIT   "'D'
        IMPORTING
          TIME_DIFF         = TIME_DIFF
        EXCEPTIONS
          WRONG_VALUE       = 1
          OTHERS            = 2    .
      IF SY-SUBRC = 0.
        IF TIME_DIFF < '999999'.
          T_DATA-DURATION  = TIME_DIFF .
        ELSE.
          T_DATA-DURATION  = '999999'.
        ENDIF.
      ENDIF.
      MODIFY T_DATA INDEX SY_TABIX.
    ENDIF.
  ENDLOOP.
  DELETE T_DATA WHERE DURATION  NOT IN R_DURATION .
******************************************************************************
********************************************************************************
"--- Set Descriptions
  LOOP AT T_DATA .
    SY_TABIX = SY-TABIX .
    "-- BSTYP_DESC
    LV_DOMNAME = 'BSTYP'.
    LV_DOMVALUE = T_DATA-BSTYP.
    CALL FUNCTION '/SKN/F_SW_GET_DOMAIN_VALUE'
      EXPORTING
        I_DOMNAME        = LV_DOMNAME
        I_DOMVALUE       = LV_DOMVALUE
        LANGU            = LV_LANGU
*       SW_DEST          =
      IMPORTING
        E_DDTEXT         = LV_DDTEXT
      EXCEPTIONS
        NOT_EXIST        = 1
        OTHERS           = 2.
    IF SY-SUBRC = 0.
      T_DATA-BSTYP_DESC = LV_DDTEXT.
    ENDIF.
    "-- STATU_DESC
    LV_DOMNAME = 'BANST'.     """''ESTAK'.
    LV_DOMVALUE = T_DATA-STATU.
    CALL FUNCTION '/SKN/F_SW_GET_DOMAIN_VALUE'
      EXPORTING
        I_DOMNAME        = LV_DOMNAME
        I_DOMVALUE       = LV_DOMVALUE
        LANGU            = LV_LANGU
*       SW_DEST          =
      IMPORTING
        E_DDTEXT         = LV_DDTEXT
      EXCEPTIONS
        NOT_EXIST        = 1
        OTHERS           = 2.
    IF SY-SUBRC = 0.
      T_DATA-STATU_DESC = LV_DDTEXT.
    ENDIF.
**    ENDIF.
    "-- BSART_DESC type ESART
    LV_BSART = T_DATA-BSART.
    CALL FUNCTION '/SKN/F_SW_10_BSART_DESC'
      EXPORTING
        BSART            = LV_BSART """"t_data-BSART
        LANGU            = LV_LANGU
        BSTYP            = T_DATA-BSTYP
      IMPORTING
        TYPE_DESC        = T_DATA-BSART_DESC
      EXCEPTIONS
        WRONG_CODE       = 1
        OTHERS           = 2.
    IF SY-SUBRC <> 0.
    ENDIF.
    "--- Get  Vendor Decriptions type LIFNR
     LV_WLIEF = T_DATA-LIFNR.
     CALL FUNCTION '/SKN/F_SW_10_VENDOR_DESC'
       EXPORTING
         LIFNR              = LV_WLIEF """t_data-LIFNR
       IMPORTING
         VENDOR_DESC        = T_DATA-VENDOR_DESC
       EXCEPTIONS
         WRONG_VENDOR       = 1
         OTHERS             = 2.
     IF SY-SUBRC <> 0.
     ENDIF.
   "-- EKORG_DESC type EKORG
    CALL FUNCTION '/SKN/F_SW_10_PUR_ORG_DESC'
      EXPORTING
        EKORG              = T_DATA-EKORG
        "LANGU              = lv_LANGU
      IMPORTING
        PUR_ORG_DESC       = T_DATA-EKORG_DESC
      EXCEPTIONS
        WRONG_CODE         = 1
        OTHERS             = 2.
    IF SY-SUBRC <> 0.
    ENDIF.
   "-- EKGRP_DESC type EKGRP
    CALL FUNCTION '/SKN/F_SW_10_PUR_GRP_DESC'
      EXPORTING
        EKGRP              = T_DATA-EKGRP
*       LANGU              = lv_LANGU
      IMPORTING
        PUR_GRP_DESC       = T_DATA-EKGRP_DESC
      EXCEPTIONS
        WRONG_CODE         = 1
        OTHERS             = 2.
    IF SY-SUBRC <> 0.
    ENDIF.
"---- WERKS_DESC lv_WERKS
     LV_WERKS = T_DATA-WERKS.
     CALL FUNCTION '/SKN/F_SW_10_PLANT_DESC'
       EXPORTING
         WERKS            = LV_WERKS    """"t_data-RESWK
*        LANGU            = lv_LANGU
       IMPORTING
         PLANT_DESC       = T_DATA-WERKS_DESC
       EXCEPTIONS
         WRONG_CODE       = 1
         OTHERS           = 2.
     IF SY-SUBRC <> 0.
     ENDIF.
    "--- RESWK_DESC (WERKS) type-WERKS_D
    LV_RESWK = T_DATA-RESWK.
     CALL FUNCTION '/SKN/F_SW_10_PLANT_DESC'
       EXPORTING
         WERKS            = LV_RESWK    """"t_data-RESWK
*        LANGU            = lv_LANGU
       IMPORTING
         PLANT_DESC       = T_DATA-RESWK_DESC
       EXCEPTIONS
         WRONG_CODE       = 1
         OTHERS           = 2.
     IF SY-SUBRC <> 0.
     ENDIF.
    MODIFY T_DATA INDEX SY_TABIX.
  ENDLOOP.
*--- Check Alert Information
 READ TABLE T_DATA INDEX 1.
 CHECK NOT SY-TFILL  IS INITIAL .
 IS_ALERT = 'X' .
ENDFUNCTION.